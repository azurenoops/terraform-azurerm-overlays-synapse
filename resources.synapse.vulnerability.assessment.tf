# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

resource "azurerm_synapse_workspace_vulnerability_assessment" "synapse_workspace_vulnerability_assessment" {
  count = var.sql_defender == null ? 0 : 1

  depends_on = [
    azurerm_role_assignment.audit_storage
  ]
  workspace_security_alert_policy_id = azurerm_synapse_workspace_security_alert_policy.synapse_workspace_security_alert_policy[0].id
  storage_container_path             = format("%s%s/",
    data.azurerm_storage_account.audit_logs.0.primary_blob_endpoint,
    data.azurerm_storage_container.vulnerability_assessment.0.name
  )
  storage_account_access_key         = data.azurerm_storage_account.audit_logs.0.primary_access_key

  dynamic "recurring_scans" {
    for_each = toset(var.sql_defender.recurring_scans == null ? [] : [var.sql_defender.recurring_scans])
    content {
      enabled                           = recurring_scans.value.enabled
      email_subscription_admins_enabled = recurring_scans.value.email_subscription_admins_enabled
      emails                            = recurring_scans.value.emails
    }
  }
}
